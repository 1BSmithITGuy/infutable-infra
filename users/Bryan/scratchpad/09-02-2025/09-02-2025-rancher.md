# 09-02-2025

## Inbox

Rancher project

## Notes

### 1.  Run k3s installer script with trafik disabled and change kubeconfig perms; helm install.

Install k3s with options:
```bash
curl -sfL https://get.k3s.io | sh -s - --disable traefik --write-kubeconfig-mode 644

```
Copy kubeconfig to local profile:
```bash
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
```

Helm - add helm repo and install:
```bash
# 1. Add the Helm GPG key
curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -

# 2. Install apt-transport-https (allows apt to use HTTPS repos)
sudo apt install apt-transport-https --yes

# 3. Add the official Helm apt repo
echo "deb https://baltocdn.com/helm/stable/debian/ all main" | \
  sudo tee /etc/apt/sources.list.d/helm-stable-debian.list

# 4. Update apt so it knows about the new repo
sudo apt update

# 5. Install Helm
sudo apt-get install helm
```

### 2.  Ingress (nginx):


Create namespace:
```bash
kubectl create namespace ingress-nginx
```

Add helm repo for nginx:

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
```

Install NGINX as daemonset, and use flags so hostport is used.
```bash
helm install ingress-nginx ingress-nginx/ingress-nginx   --namespace ingress-nginx   --set controller.kind=DaemonSet   --set controller.hostPort.enabled=true   --set controller.publishService.enabled=false   --set controller.service.type=ClusterIP
```


-   **Get pods should look like this when install complete:**
```
NAMESPACE       NAME                                      READY   STATUS    RESTARTS   AGE
ingress-nginx   ingress-nginx-controller-gjsvr            1/1     Running   0          63s
kube-system     coredns-64fd4b4794-7grfn                  1/1     Running   0          29m
kube-system     local-path-provisioner-774c6665dc-mhdx4   1/1     Running   0          29m
kube-system     metrics-server-7bfffcd44-k84rc            1/1     Running   0          29m
```

-   **Confirm hostPort is setup**
```bash
kubectl get ds -n ingress-nginx -o yaml | grep -A5 "hostPort"
```

### 3.  Install Cert manager and Rancher

Add Rancher and jetstack repos:
```bash
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
helm repo add jetstack https://charts.jetstack.io

helm repo update
```

Install cert manager:
```bash
helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set installCRDs=true
  ```

Create Namespace:
```bash
kubectl create namespace cattle-system
```

Install rancher with flags for domain:
```bash
helm install rancher rancher-stable/rancher --namespace cattle-system --create-namespace --set hostname=rancher.infutable.com --set bootstrapPassword=admin --set replicas=1
```

setup ingress:

I created an ingress.yaml file in the repo.  Here is what is in it:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rancher
  namespace: cattle-system
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
  - host: rancher.infutable.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rancher
            port:
              number: 80
  tls:
  - hosts:
    - rancher.infutable.com
    secretName: tls-rancher-ingress
```

***setup dns A record***

### 4.  Import clusters:

For both clusters, in the rancher UI:

1. Click Import>>generic
2. Create a name for the cluster
3. Run the command on those cluster (use the self signed command)

### 5.  Setup monitoring:

Add repo:
```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
```

Install node-exporter:
```bash
helm install node-exporter prometheus-community/prometheus-node-exporter -n monitoring --create-namespace --set service.type=NodePort --set service.nodePort=30910
```

Install kube-state-metrics:
```bash
helm install kube-state-metrics prometheus-community/kube-state-metrics -n monitoring --set service.type=NodePort --set service.nodePort=30911
```

Add the following to prometheus-values.yaml:

```yaml
# k3s Management Cluster (rancher) - Node Exporter
    - job_name: 'rancher-node'
      static_configs:
      - targets: 
        - 'bsus103k-mgt01:30910'
      relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '${1}'
      - target_label: cluster
        replacement: 'rancher-management'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'
      - target_label: node_type
        replacement: 'management'
    
    # k3s Management Cluster (rancher) - Kube State Metrics
    - job_name: 'rancher-kube-state'
      static_configs:
      - targets: ['bsus103k-mgt01:30911']
      relabel_configs:
      - target_label: cluster
        replacement: 'rancher-management'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'
```
LEFT OFF:  NEED TO RUN DEPLOY.SH,
```bash

```

```bash

```

###  Troubleshooting

To list all cluster in rancher and delete:
```bash
kubectl get clusters.management.cattle.io -A

kubectl delete clusters.management.cattle.io <Cluster_Name>
```

# Check Rancher pod logs
```bash
kubectl logs -n cattle-system deployment/rancher --tail=50
```
