# Cilium Deployment (Talos-Compatible)

This directory contains everything needed to deploy **Cilium** (with Hubble) in a Talos-based Kubernetes cluster while avoiding the known issues with Talos and container capabilities.

## Files in this directory

- **`cilium-rendered.yaml`** – The raw manifests generated by Helm (`helm template`). This is the full Cilium release (CRDs, DaemonSets, Deployments, ConfigMaps, etc.).
- **`patch-cilium-daemonset.yaml`** – A Kustomize patch that:
  - removes the `clean-cilium-state` init container (Talos does not allow the required `CAP_SYS_MODULE` capability),
  - switches the CNI binary path to `/var/lib/cni/bin` (Talos convention),
  - drops `SYS_MODULE` from the Cilium agent’s security context capabilities.
- **`kustomization.yaml`** – Ties it together: includes the Helm-rendered manifests and applies the patch.


## Deployment workflow

1. **Render the Helm chart once into a file:**
   ```bash
   helm repo add cilium https://helm.cilium.io
   helm repo update

   helm template cilium cilium/cilium \
     --version 1.18.1 \
     -n kube-system \
     --set operator.replicas=1 \
     --set ipam.mode=cluster-pool \
     --set cluster.name=us103-talos01 \
     --set cluster.id=103 \
     --set clusterPoolIPv4PodCIDR=10.244.0.0/16 \
     --set clusterPoolIPv4MaskSize=24 \
     --set hubble.enabled=true \
     --set hubble.relay.enabled=true \
     --set hubble.ui.enabled=true \
     > cilium-rendered.yaml
   ```

2. **Apply with Kustomize to inject Talos fixes:**
   ```bash
   kubectl apply -k .
   ```

That’s it—your cluster now runs Cilium with Hubble UI, Hubble Relay, and a Talos-safe DaemonSet.

## Notes on upgrades

- Re-run the same `helm template … > cilium-rendered.yaml` command with the new chart version and updated values.
- Then run `kubectl apply -k .` again.

