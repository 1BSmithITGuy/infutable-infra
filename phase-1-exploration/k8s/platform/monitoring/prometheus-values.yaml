# ===================== Grafana Configuration =====================
grafana:
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - grafana.infra.infutable.com
  
  # Password auto-generated if not set
  # adminPassword: ""
  
  # Dashboards are stored in persistent volume (grafana.db)
  # Dashboard auto-provisioning disabled to prevent duplicates
  persistence:
    enabled: true
    type: pvc
    storageClassName: local-path
    size: 5Gi
    accessModes:
      - ReadWriteOnce

  # Disable init container that tries to chown directories
  # Not needed since files are already owned by grafana user (472)
  initChownData:
    enabled: false

# ===================== Prometheus Configuration =====================
prometheus:
  prometheusSpec:
    # Data retention and storage
    retention: 15d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    
    # External labels to identify THIS Prometheus instance
    externalLabels:
      cluster: us103-kubeadm01
      site_code: us103
      provider: on-prem
      prometheus_instance: primary
    
    # ===================== External Monitoring Targets =====================
    additionalScrapeConfigs:
    
    # K3s Cluster - Node Exporter
    # Deployed via: kubectl --context=us103-k3s01 apply -f external-monitoring/deploy-node-exporter.sh
    - job_name: 'k3s-nodes'
      static_configs:
      - targets: 
        - 'bsus103km01:30910'  # K3s master node
        # Add additional K3s nodes here as needed
      relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '${1}'
      - target_label: cluster
        replacement: 'us103-k3s01'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'
      - target_label: node_type
        replacement: 'master'
    
    # K3s Cluster - Kube State Metrics
    # Deployed via: kubectl --context=us103-k3s01 apply -f external-monitoring/deploy-kube-state-metrics.sh
    - job_name: 'k3s-kube-state'
      static_configs:
      - targets: ['bsus103km01:30911']
      relabel_configs:
      - target_label: cluster
        replacement: 'us103-k3s01'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'

    # k3s Management Cluster (rancher) - Node Exporter
    - job_name: 'rancher-node'
      static_configs:
      - targets: 
        - 'bsus103k-mgt01:30910'
      relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '${1}'
      - target_label: cluster
        replacement: 'rancher-management'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'
      - target_label: node_type
        replacement: 'management'
    
    # k3s Management Cluster (rancher) - Kube State Metrics
    - job_name: 'rancher-kube-state'
      static_configs:
      - targets: ['bsus103k-mgt01:30911']
      relabel_configs:
      - target_label: cluster
        replacement: 'rancher-management'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'

    # us103-talos01 Cluster - node exporter
    - job_name: 'us103-talos01-node-exporter'
      static_configs:
      - targets: 
        - 'bsus103tal-k8m01.k8s.infutable.com:30910'
        - 'bsus103tal-k8w01.k8s.infutable.com:30910'
        - 'bsus103tal-k8w02.k8s.infutable.com:30910'
      relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '${1}'
      - target_label: cluster
        replacement: 'us103-talos01'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'
    
    # k8s Talos cluster - Kube State Metrics
    - job_name: 'us103-talos01-kube-state'
      static_configs:
      - targets: ['bsus103tal-k8m01.k8s.infutable.com:30911']
      relabel_configs:
      - target_label: cluster
        replacement: 'us103-talos01'
      - target_label: site_code
        replacement: 'us103'
      - target_label: provider
        replacement: 'on-prem'